#!/bin/bash
set -eu

# Detect # of CPUs so make jobs can be parallelized
CPUS=$(grep -c ^processor /proc/cpuinfo)
 # Available variables
# $BOSH_COMPILE_TARGET - where this package & spec'd source files are available
# $BOSH_INSTALL_TARGET - where you copy/install files to be included in package
export HOME=/var/vcap

# see https://ftp.postgresql.org/pub/source/
# see https://www.postgresql.org/ftp/source/

cd postgres/
sha256sum --check *.sha256
cd -

tar -xjf postgres/postgresql-*.tar.bz2

pushd postgresql-* > /dev/null
  if [[ "$(uname -a)" =~ "x86_64" || "$(uname -a)" =~ "ppc64le" ]] ; then
    ./configure --prefix="${BOSH_INSTALL_TARGET}" --with-openssl
  else
    CFLAGS=-m32 LDFLAGS=-m32 CXXFLAGS=-m32 ./configure --prefix="${BOSH_INSTALL_TARGET}"  --with-openssl
  fi

  pushd src/bin/pg_config > /dev/null
    make -j$(nproc)
    make install
  popd > /dev/null

  cp -LR src/include "${BOSH_INSTALL_TARGET}"
  pushd src/interfaces/libpq > /dev/null
    make -j$(nproc)
    make install
  popd > /dev/null

  pushd src > /dev/null
    make -j$(nproc)
    make install
  popd > /dev/null

  pushd contrib > /dev/null
    make -j$(nproc)
    make install
  popd > /dev/null
popd > /dev/null
